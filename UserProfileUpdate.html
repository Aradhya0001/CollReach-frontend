<html>
<!--USER_PROFILE_UPDATE FRONT_END-->

<head>
    <style>
        #skillset {
            width: 230px;
            height: auto;
            margin-top: 20px;
            overflow: scroll;
            background: #202020;
            padding: 20px;
            display: block;
        }
    </style>

    <title>Profile Update</title>
    <link rel="icon" href="CollReach.PNG" type="image/x-icon">
    <script type="text/javascript">
        var arr = new Array();
        var userInfo = "";
        // checks password validity
        function validatePassword() {
            var newPassword = document.passwordUpdate.newPassword.value;
            if (newPassword != "") {
                if (/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/.test(newPassword) != true) {
                    alert("Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters");
                    return false;
                }
            }
            return true;
        }


        //checks email correctness
        function emailcorrector() {
            var personalEmail = document.personalEmailUpdate.personalEmail.value;
            if (personalEmail != "") {
                if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(personalEmail) != true) {
                    alert("Personal email is wrong");
                    return false;
                }
            }
            return true;
        }
        
        
        //checks linkedin link correctness
        function linkedIncorrector() {
            var linkedIn = document.linkedInUpdate.linkedIn.value;
            if (linkedIn != "") {
                if (/((https?:\/\/)?((www|\w\w)\.)?linkedin\.com\/)((([\w]{2,3})?)|([^\/]+\/(([\w|\d-&#?=])+\/?){1,}))$/.test(linkedIn) != true) {
                    alert("Wrong LinkedIn link");
                    return false;
                }
            }
            return true;
        }
        
        //checks if the email exists or not
        function validateEmail() {
            var personalEmail = document.personalEmailUpdate.personalEmail.value;
            personalEmail === "" ? personalEmail = "null" : personalEmail = personalEmail;

            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/check-email";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log(xhr.responseText);
                    var errorMsg = document.getElementById("validateEmail");
                    if (xhr.responseText != "") {
                        document.getElementById("personalEmail").style.background = "red";
                        document.getElementById("personalEmail").style.color = "white";
                        errorMsg.style.display = "block";
                        errorMsg.innerHTML = (xhr.responseText);
                        errorMsg.style.color = "red";
                    } else if (personalEmail === "" || xhr.responseText === "") {
                        document.getElementById("personalEmail").style.background = "white";
                        document.getElementById("personalEmail").style.color = "black";
                        errorMsg.style.display = "none";
                    }
                }
            };
            var data = JSON.stringify({
                "email": personalEmail
            });
            xhr.send(data);
        }
        
        
        //checks if phone number exists or not
        function validatePhoneNo() {
            var phoneNo = document.phoneNoUpdate.phoneNo.value;
            phoneNo === "" ? phoneNo = "null" : phoneNo = phoneNo;

            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/check-phone-no";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log(xhr.responseText);
                    var errorMsg = document.getElementById("phoneNovalidation");
                    if (xhr.responseText != "") {
                        document.getElementById("phoneNo").style.background = "red";
                        document.getElementById("phoneNo").style.color = "white";
                        errorMsg.style.display = "block";
                        errorMsg.innerHTML = (xhr.responseText);
                        errorMsg.style.color = "red";
                    } else if (phoneNo === "" || xhr.responseText === "") {
                        document.getElementById("phoneNo").style.background = "white";
                        document.getElementById("phoneNo").style.color = "black";
                        errorMsg.style.display = "none";
                    }
                }
            };
            var data = JSON.stringify({
                "phoneNo": phoneNo
            });
            xhr.send(data);
        }


        function validatelinkedInlink() {
            var linkedIn = document.linkedInUpdate.linkedIn.value;
            linkedIn === "" ? linkedIn = "null" : linkedIn = linkedIn;

            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/check-linkedin-link";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log(xhr.responseText);
                    var errorMsg = document.getElementById("linkedInvalidation");
                    if (xhr.responseText != "") {
                        document.getElementById("linkedIn").style.background = "red";
                        document.getElementById("linkedIn").style.color = "white";
                        errorMsg.style.display = "block";
                        errorMsg.innerHTML = (xhr.responseText);
                        errorMsg.style.color = "red";
                    } else if (linkedIn === "" || xhr.responseText === "") {
                        document.getElementById("linkedIn").style.background = "white";
                        document.getElementById("linkedIn").style.color = "black";
                        errorMsg.style.display = "none";
                    }
                }
            };
            var data = JSON.stringify({
                "linkedinLink": linkedIn
            });
            xhr.send(data);
        }
        
        
        //updates Alternative Email
        function EmailUpdate() {
            var personalEmail = document.personalEmailUpdate.personalEmail.value;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/alternate-email";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1036",
                "password": "Aradhya@1",
                "alternateEmail": personalEmail

            });
            xhr.send(data);
        }
        //Updates Phone Number
        function phonenoUpdate() {
            var phoneNo = document.phoneNoUpdate.phoneNo.value;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/phone-no";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg1");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1036",
                "password": "Aradhya@1",
                "phoneNo": phoneNo

            });
            xhr.send(data);
        }
        
        //updates Description
        function DescriptionUpdate() {
            var description = document.descriptionUpdate.description.value;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/description";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg2");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1049",
                "password": "Ayush@1",
                "description": description

            });
            xhr.send(data);

        }
        //update linkedin link
        function linkedinUpdate() {
            var linkedIn = document.linkedInUpdate.linkedIn.value;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/linkedin-link";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg3");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1049",
                "password": "Ayush@12",
                "linkedinLink": linkedIn

            });
            xhr.send(data);

        }
        
        
        function courseIdMapping(course,branch,sem,year) {
            var courseId;
                    
            if ((course == "B.tech") && (branch == "CSE") && (sem == "5") && (year == "3"))
                courseId = 1;
            else if ((course == "B.tech") && (branch == "CSE") && (sem == "4") && (year == "2"))
                courseId = 3;
            else if ((course == "B.tech") && (branch == "ME") && (sem == "5") && (year == "3"))
                courseId = 2;
            else if ((course == "B.tech") && (branch == "EN") && (sem == "5") && (year == "3"))
                courseId = 11;
            else if ((course == "B.tech") && (branch == "ECE") && (sem == "5") && (year == "3"))
                courseId = 4;
            else if ((course == "B.tech") && (branch == "CE") && (sem == "5") && (year == "3"))
                courseId = 5;
            else if ((course == "B.tech") && (branch == "CSI") && (sem == "7") && (year == "4"))
                courseId = 6;
            else if ((course == "B.tech") && (branch == "CO") && (sem == "5") && (year == "3"))
                courseId = 7;
            else if ((course == "B.tech") && (branch == "IT") && (sem == "5") && (year == "3"))
                courseId = 8;
            else if ((course == "B.tech") && (branch == "EIE") && (sem == "5") && (year == "3"))
                courseId = 9;
            else if ((course == "B.tech") && (branch = "ECE") && (sem == "4") && (year == "2"))
                courseId = 10;
            
            return courseId;
        }
        
        //update semester and year
        function YearsemUpdate() {
            var courseId;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/login";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log(xhr.responseText);
                    userInfo = JSON.parse(xhr.responseText);
                    console.log("userInfo" + userInfo.userPersonalInfoResponse.courseInfoResponse.courseName);
                    
                    console.log("inside mapping" + userInfo);
                    var course = userInfo.userPersonalInfoResponse.courseInfoResponse.courseName;
                    var branch = userInfo.userPersonalInfoResponse.courseInfoResponse.branch;
                    var sem = document.yearsemUpdate.sem.value;
                    var year = String(Math.ceil(Number(sem) / 2));
                    console.log(year +" " + branch + " " + course);
                    
                    courseId = courseIdMapping(course,branch,sem,year);
                        
                    console.log("courseInfo : " + courseId);
                    var xhr2 = new XMLHttpRequest();
                    var url = "http://localhost:8082/user/course-id";
                    xhr2.open("PUT", url, true);
                    xhr2.setRequestHeader("Content-Type", "application/json");
                    xhr2.onreadystatechange = function() {
                        if (xhr2.readyState === 4 && xhr2.status === 200) {
                            var responseMsg = xhr2.responseText;
                            console.log(responseMsg);
                            var msg = document.getElementById("msg4");
                            msg.innerHTML = "</br>" + (xhr2.responseText);
                            if (responseMsg.includes("Error"))
                                msg.style.color = "red";
                            else
                                msg.style.color = "green";
                        }
                    };
                    var data2 = JSON.stringify({
                        "userName": "1822cs1049",
                        "password": "Ayush@1",
                        "courseId": courseId
                    });
                    xhr2.send(data2);
                    
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1049",
                "password": "Ayush@1"
            });
            xhr.send(data);
        }

        
        //change password
        function PasswordUpdate() {
            var newPassword = document.passwordUpdate.newPassword.value;
            var password = document.passwordUpdate.password.value;
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/password";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg6");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var data = JSON.stringify({
                "userName": "1822cs1049",
                "password": password,
                "newPassword": newPassword

            });
            xhr.send(data);
        }
        //send password to backend after proper validations
        function sendPasswordData() {
            if (validatePassword() == true) {
                PasswordUpdate();
            } else
                return false;
        }
        
        
        //send email to backend after proper validations
        function sendEmailData() {
            if (emailcorrector() == true) {
                EmailUpdate();
            } else
                return false;
        }

        
        //send updated linkedIn link to database
        function linkedInDataSend() {
            if (linkedIncorrector() == true) {
                linkedinUpdate();
            } else
                return false;
        }


        function skillIdmapping(skill) {
            //var skill = document.skillUpdate.skill.value;
            if (skill == "AI")
                return 5;  //9
            else if (skill == "Android")
                return 2;  //11
            else if (skill == "Deep Learning")
                return 4;  // 10
            else if (skill == "ML")
                return 3;   // 7
            else if (skill == "Web Development")
                return 1;   // 8
        }
        
        function skillUpdate() {
            //var skill = skillIdmapping(arr);
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:8082/user/skills";
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var responseMsg = xhr.responseText;
                    console.log(responseMsg);
                    var msg = document.getElementById("msg5");
                    msg.innerHTML = "</br>" + (xhr.responseText);
                    if (responseMsg.includes("Error"))
                        msg.style.color = "red";
                    else
                        msg.style.color = "green";
                }
            };
            var mappedSkills = new Array();
            for(var i = 0; i < arr.length; i++){
                mappedSkills.push(skillIdmapping(arr[i]));
            }
            var data = JSON.stringify({
                "userName": "1822cs1049",
                "skills": mappedSkills
            });
            xhr.send(data);
        }


        function addSkill() {
            var text = document.getElementById("skill").value;
            console.log(text);
            //var node = document.createElement("LI");
            //var textnode = document.createTextNode(text);
            //node.appendChild(textnode);
            var skills = document.getElementById("skillset");
            if (!arr.includes(text)) {
                var skill = document.createElement("span");
                var textnode = document.createTextNode(text);
                skill.appendChild(textnode);
                skill.style.margin = "10px";
                skill.style.padding = "5px";
                skill.style.paddingLeft = "15px";
                skill.style.paddingRight = "15px";
                skill.style.backgroundColor = "purple";
                skill.style.color = "white";
                skill.style.borderRadius = "60px";
                skill.style.display = "block";
                skills.appendChild(skill);

                //document.getElementById("myList").appendChild(node);
                arr.push(text);
                console.log(arr);
            }
        }

    </script>
</head>

<body>
    <h2>
        <center>Profile Update</center>
    </h2>
    <form name="personalEmailUpdate" method="post" action="#">

        <label for="personalEmail">Personal Email:</label><br>
        <input type="text" id="personalEmail" name="personalEmail" onchange="validateEmail()"><br><br>
        <p id="validateEmail" style="display: none;"></p>
        <input type="button" value="Update" onclick="sendEmailData()">
        <p id="msg"></p>
    </form>

    <form name="phoneNoUpdate" method="post" action="#">
        <label for="phoneNo">Phone Number:</label><br>
        <input type="text" id="phoneNo" name="phoneNo" onchange="validatePhoneNo()"><br><br>
        <p id="PhoneNovalidation" style="display:none;"></p>
        <input type="button" value="Update" onclick="phonenoUpdate()">
        <p id="msg1"></p>
    </form>

    <form name="descriptionUpdate" method="post" action="#">
        <label for="description">Description:</label><br>
        <input type="text" id="description" name="description"><br><br>
        <input type="button" value="Update" onclick="DescriptionUpdate()">
        <p id="msg2"></p>
    </form>

    <form name="linkedInUpdate" method="post" action="#">
        <label for="linkedIn">LinkedIn Link:</label><br>
        <input type="text" id="linkedIn" name="linkedIn" onchange="validatelinkedInlink()"><br><br>
        <p id="linkedInvalidation" style="display:none;"></p>
        <input type="button" value="Update" onclick="linkedInDataSend()">
        <p id="msg3"></p>
    </form>
    <h3>UPDATE COLLEGE DETAILS:</h3><br>
    <form name="yearsemUpdate" method="post" action="#">
        <label for="sem">Semester:</label><br>
        <select id="sem" name="sem">
            <option value="none">Select semester</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
        </select><br><br>
        <input type="button" value="Update" onclick="YearsemUpdate()">
        <p id="msg4"></p>
    </form>

    <form name="skillupdate" method="post" action="#">
        <label for="skill">Skills:</label><br>
        <select id="skill" name="skill" onchange="addSkill()">
            <option value = "AI">AI</option>
            <option value = "Web Development">Web Developement</option>
            <option value = "ML">ML</option>
            <option value = "Deep Learning">Deep Learning</option>
            <option value = "Android">Android</option>
        </select><br><br>
        <div id="skillset"></div>
        <input type="button" value="Update" onclick="skillUpdate()">
        <p id="msg5"></p>
    </form>

    <h3>UPDATE PASSWORD:</h3><br>
    <form name="passwordUpdate" method="post" action="#">
        <label for="password">OLD PASSWORD:</label><br>
        <input type="text" id="password" name="password"><br>
        <label for="newPassword">NEW PASSWORD:</label><br>
        <input type="text" id="newPassword" name="newPassword"><br><br>
        <input type="button" value="Confirm" onclick="sendPasswordData()">
        <p id="msg6"></p>
    </form>


</body>

</html>
